include:
  - remote: 'https://gitlab.com/cscs-ci/recipes/-/raw/master/templates/v2/.ci-ext.yml'


.test/base:
  stage: test
  extends: .uenv-runner-daint-gh200
  image: ${UENV_NAME}/${UENV_VERSION}:${UENV_TAG}
  variables:
    WITH_UENV_VIEW: "default"
    TEST: "default"
    REFPATH: ".ci/ref_data/cscs-test"
    CFLAGS: "-O3 -fopenmp -mtune=neoverse-v2 -mcpu=neoverse-v2"
    CXXFLAGS: "-O3 -fopenmp -mtune=neoverse-v2 -mcpu=neoverse-v2"
    LDFLAGS: "-fopenmp"
  before_script:
    - |
      if test "${SLURM_PROCID}" -eq "0"; then
        echo "env"
        env
        export CC="$(which mpicc)"
        export CXX="$(which mpicxx)"
        export qudadir="$(spack find --format '{prefix}' quda)"
        export limedir="$(spack find --format '{prefix}' c-lime)"
        export lemondir="$(spack find --format '{prefix}' lemonio)"
        export blasdir="$(spack find --format '{prefix}' openblas)"
        export cudadir="$(spack find --format '{prefix}' cuda)"
        echo "env"
        env
        echo "mpicc --version || true"
        mpicc --version || true
        echo "mpicxx --version || true"
        mpicxx --version || true
        echo "mpic++ --version || true"
        mpic++ --version || true
        echo "gcc --version || true"
        gcc --version || true
        echo "cc --version || true"
        cc --version || true
        echo "make --version || true"
        make --version || true
        echo "spack --version || true"
        spack --version || true
        echo "compgen -ac || true"
        compgen -ac || true
        ls -la "${qudadir}" || true
        ls -la "${limedir}" || true
        ls -la "${lemondir}" || true
        ls -la "${blasdir}/lib/libopenblas.a" || true
        ls -la "${cudadir}/lib64" || true
        mkdir install_dir || true
        autoconf || true
        ./configure \
          --enable-quda_experimental \
          --enable-mpi \
          --enable-omp \
          --with-mpidimension=4 \
          --disable-sse2 \
          --disable-sse3 \
          --enable-alignment=32 \
          --with-qudadir="${qudadir}" \
          --with-limedir="${limedir}" \
          --with-lemondir="${lemondir}" \
          --with-lapack="${blasdir}/lib/libopenblas.a" \
          --with-cudadir="${cudadir}/lib64" \
          --prefix="$(pwd)/install_dir" || true
        make || true
        make install || true
        touch preparation-done-${CI_JOB_ID}
      fi
    - while test ! -f preparation-done-${CI_JOB_ID}; do sleep 5; done
  script:
    - echo "Now run binary on SLURM_PROCID=${SLURM_PROCID} with INPUT_FILE=${INPUT_FILE} ..."
  after_script:
    - echo "Now check results on SLURM_PROCID=${SLURM_PROCID} ..."


.test/hmc:
  extends: .test/base
  script:
    - echo "TEST = $TEST"
    - echo "REFPATH = $REFPATH"
    - ls -la install_dir
    - echo "running ./install_dir/hmc_tm -f ${INPUT_FILE}"
    - ./install_dir/hmc_tm -f "${INPUT_FILE}"
    - echo "Now run binary on SLURM_PROCID=${SLURM_PROCID} with INPUT_FILE=${INPUT_FILE} ..."
  after_script:
    - echo "Now check results on SLURM_PROCID=${SLURM_PROCID} ..."
    - numdiff -r 1e-4 -X 1:10 -X 1:5-8 -X 2:10 -X 2:5-8 output.data ${REFPATH}/output.data
    - |
      for i in $(seq 0 2 18); do \
        f=onlinemeas.$(printf %06d $i); \
        numdiff -r 1e-5 ${f} ${REFPATH}/${f}; \
      done
