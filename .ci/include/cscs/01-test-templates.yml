include:
  - remote: 'https://gitlab.com/cscs-ci/recipes/-/raw/master/templates/v2/.ci-ext.yml'


.test/base:
  stage: test
  extends: .uenv-runner-daint-gh200
  image: ${UENV_NAME}/${UENV_VERSION}:${UENV_TAG}
  variables:
    WITH_UENV_VIEW: "default"
    CFLAGS: "-O3 -fopenmp -mtune=neoverse-v2 -mcpu=neoverse-v2"
    CXXFLAGS: "-O3 -fopenmp -mtune=neoverse-v2 -mcpu=neoverse-v2"
    LDFLAGS: "-fopenmp"
  before_script:
    - |
      if test "${SLURM_PROCID}" -eq "0"; then
        export CC="$(which mpicc)"
        export CXX="$(which mpicxx)"
        mkdir -p install_dir
        autoconf
        ./configure \
          --enable-quda_experimental \
          --enable-mpi \
          --enable-omp \
          --with-mpidimension=4 \
          --disable-sse2 \
          --disable-sse3 \
          --enable-alignment=32 \
          --with-qudadir="/user-environment/env/default" \
          --with-limedir="/user-environment/env/default" \
          --with-lemondir="/user-environment/env/default" \
          --with-lapack="-lopenblas -L/user-environment/env/default/lib" \
          --with-cudadir="/user-environment/env/default/lib64" \
          --prefix="$(pwd)/install_dir"
        make
        make install
        touch preparation-done-${CI_JOB_ID}
      fi
    - while test ! -f preparation-done-${CI_JOB_ID}; do sleep 5; done


.test/hmc:
  extends: .test/base
  script:
    - ./install_dir/bin/hmc_tm -f "${INPUT_FILE}"
    - |
      if test "${SLURM_PROCID}" -eq "0"; then
        echo "Now check the results on SLURM_PROCID=${SLURM_PROCID} ..."
        numdiff -r 1e-6 -X 1:22 -X 1:5-21 -X 2:22 -X 2:5-21 output.data ${REFPATH}/output.data
        for i in $(seq 0 2 18); do
          f=onlinemeas.$(printf %06d $i);
          echo "Checking i=${i} and f=${f} ...";
          numdiff -r 1e-8 ${f} ${REFPATH}/${f};
        done
      fi
